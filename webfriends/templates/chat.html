{% extends 'layout.html' %}
{% block content %}
<h2 class="title is-4 mb-3">SpeedMeet (демо)</h2>
<p>Откройте эту страницу в двух окнах браузера для демонстрации видеосвязи.</p>
<video id="local" autoplay playsinline muted class="box"></video>
<video id="remote" autoplay playsinline class="box mt-4"></video>
<script>
let pc = new RTCPeerConnection();
let local = document.getElementById('local');
let remote = document.getElementById('remote');
navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{
  local.srcObject = stream;
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  pc.createOffer().then(o=>pc.setLocalDescription(o));
});
pc.ontrack = ev => { remote.srcObject = ev.streams[0]; };
window.onhashchange = async ()=>{
  if(location.hash.startsWith('#')){
    let offer = JSON.parse(atob(location.hash.slice(1)));
    await pc.setRemoteDescription(offer);
    let ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    alert('Скопируйте эту ссылку и откройте в другом окне:\n'+location.origin+location.pathname+'#'+btoa(JSON.stringify(ans)));
  }
};
</script>
{% endblock %}
